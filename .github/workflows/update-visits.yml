name: Update Cloudflare Visits

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  update-visits:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Fetch Cloudflare daily visits
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          ZONE_ID: ${{ secrets.CLOUDFLARE_ZONE_ID }}
        run: |
          echo "Fetching Cloudflare analytics..."
          today=$(date -u +"%Y-%m-%d")
          start=$(date -u --date="364 days ago" +"%Y-%m-%d")

          QUERY="{\"query\": \"query(\\$zone: String!, \\$start: String!) { viewer { zones(filter: {zoneTag: \\$zone}) { httpRequests1dGroups(limit: 365, filter: {date_geq: \\$start}) { dimensions { date } sum { visits } } } } }\", \"variables\": {\"zone\": \"$ZONE_ID\", \"start\": \"$start\"}}"

          curl -s -X POST "https://api.cloudflare.com/client/v4/graphql" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN" \
            --data "$QUERY" \
            > cloudflare-response.json

          python3 -c "import json; f=open('cloudflare-response.json'); data=json.load(f); f.close(); visits=[{'date':g['dimensions']['date'],'visits':g['sum']['visits']} for g in data['data']['viewer']['zones'][0]['httpRequests1dGroups']]; json.dump(visits, open('visits.json','w'), indent=2)"

      - name: Commit visits.json
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          if [ -f visits.json ]; then
            git add visits.json
            if git diff --cached --quiet; then
              echo "No changes to commit"
            else
              git commit -m "Update visits"
              git push
            fi
          else
            echo "visits.json not found"
          fi

